# c-error
> 一个 JSON 安全、C 语言友好的分层错误码规范及 lastError 的C语言实现

🎯 项目简介
本项目提供了一套面向 Web + 嵌入式混合系统 的统一错误码设计规范，以及高效的 C 语言实现。解决了跨语言、跨系统场景下错误码定义与解析不一致的核心痛点。
核心特性

✅ JSON 完全兼容：基于 53 位无符号整数（IEEE 754 安全整数范围）
✅ C/C++ 原生友好：64 位无符号整型存储
✅ 双模式架构：支持 53 位全局模式与 32 位紧凑模式无损切换
✅ Thread-Safe 实现：基于 thread_local 的零成本错误传播机制
✅ 完整错误上下文：内置错误字符串描述能力

---

📐 设计理念
- 1. JSON 安全兼容 
    错误码基于 **53 位无符号整数**，满足 IEEE 754 双精度浮点数的安全整数范围要求。

- 2. C 语言友好设计
- **64 位存储空间**：`uint64_t` 原生支持
- **高位安全预留**：`[62:53]` 共 10 位可用于调试标记或私有状态
- **禁用最高位语义**：避免 `signed/unsigned` 类型转换问题

- 3. 灵活的双模式架构

| 模式 | 位宽 | 适用场景 | 全局唯一性 |
|------|------|----------|------------|
| **标准模式** | 53 bit | 微服务、多产品线、Web API | ✅ 支持 |
| **紧凑模式** | 32 bit | 单体应用、嵌入式、IoT | ❌ 仅局部 |

---
## 🏗️ 错误码结构

### 标准模式（53 位）
```
 63        53  52      40  39    32  31    21  20  16  15             0
┌───────────┬──────────┬─────────┬─────────┬───────┬─────────────────┐
│  Reserved │Reserved-2│Software │Component│ Status│   Error Code    │
│  (11 bit) │ (13 bit) │ (8 bit) │ (11 bit)│(5 bit)│    (16 bit)     │
└───────────┴──────────┴─────────┴─────────┴───────┴─────────────────┘
     未使用      Part C-1    Part C-2   Part C-3   Part B      Part A
```
### 紧凑模式（32 位）
cuint32_t compact = (uint32_t)(standard_code & 0xFFFFFFFF);
保留 [31:0] 核心错误信息，丢失全局产品/软件标识。

---

💻 C 语言实现
核心 API
```
c// 设置错误（Thread-Local）
void set_last_error(uint64_t code, const char* message);

// 获取错误码
uint64_t get_last_error(void);

// 获取错误描述
const char* get_last_error_message(void);

// 清除错误
void clear_last_error(void);
```
实现特点

- 零成本抽象：基于 _Thread_local（C11）或 __thread（GCC/Clang）
- 线程隔离：每个线程独立错误上下文，无竞争条件
- 内存安全：错误字符串生命周期自动管理
